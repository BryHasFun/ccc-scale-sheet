<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCC 4-Corner Scale Sheet</title>
  <style>
    :root{
      --page-w: 1024px;
      --gap: 14px;
      --border: 2px;
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;

      /* CAD-like layout tuning knobs */
      --car-max: 420px;          /* car image max width */
      --side-col-w: 280px;       /* left/right column width */
      --side-y-nudge: 0px;       /* optional fine-tune: e.g. 18px, 28px */
    }

    body{
      margin:0;
      background:#f2f2f2;
      font-family:var(--font);
      color:#111;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .page{
      width: min(var(--page-w), 100%);
      background:#fff;
      border:1px solid #ddd;
      border-radius:18px;
      box-shadow: 0 8px 22px rgba(0,0,0,.08);
      padding: 18px;
    }

    /* Header */
    .logo{
      display:flex;
      justify-content:center;
      margin-top:4px;
      margin-bottom:10px;
    }
    .logo img{ max-width: 420px; width: 60%; height:auto; }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
      margin: 6px 0 14px;
    }
    .meta2{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      margin-bottom: 14px;
    }
    .field{
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .field label{
      font-weight:700;
      font-size:14px;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      padding:10px 10px;
      border:1px solid #bbb;
      border-radius:10px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input[type="number"]{ appearance:textfield; }

    /* Blocks */
    .block{
      border: var(--border) solid #111;
      border-radius: var(--radius);
      padding: 10px 10px 12px;
      margin-bottom: 12px;
    }
    .block h3{
      margin:0 0 8px;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .rows{
      display:grid;
      grid-template-columns: 72px 1fr 1fr 42px;
      gap:8px;
      align-items:center;
    }
    .rows .rowlbl{
      font-weight:700;
      font-size:13px;
    }
    .unit{
      font-weight:700;
      font-size:13px;
      text-align:right;
      opacity:.9;
    }
    .small{
      font-size:12px;
      opacity:.8;
      margin-top: 8px;
    }

    /* ==========================
       CAD-LIKE MAIN LAYOUT
       ==========================
       3 columns (Left / Center / Right)
       3 rows in the CENTER column (Front axle / Car / Rear axle)
       Left + Right columns are pinned to the CAR row and vertically centered there.
    */
    .layout{
      display:grid;
      grid-template-columns: var(--side-col-w) 1fr var(--side-col-w);
      gap: var(--gap);
      align-items:start;
    }

    .center{
      display:grid;
      grid-template-rows: auto auto auto;
      gap: 12px;
      justify-items:center;
    }

    .carRow{
      width: 100%;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
    }
    .carRow img{
      width: 100%;
      max-width: var(--car-max);
      height:auto;
      object-fit:contain;
      display:block;
    }

    /* Left + right stacks centered to carRow height */
    .sideStack{
      grid-row: 1 / span 1; /* not used here; just semantic */
      transform: translateY(var(--side-y-nudge));
      display:flex;
      flex-direction:column;
      justify-content:center; /* key: center stacks against car row */
    }

    /* Put the side stacks aligned with the car image row */
    .layout .leftCol,
    .layout .rightCol{
      display:flex;
      flex-direction:column;
    }
    .layoutGrid{
      display:grid;
      grid-template-columns: var(--side-col-w) 1fr var(--side-col-w);
      gap: var(--gap);
      align-items:start;
    }
    .layoutGrid .center{
      grid-column: 2;
    }

    /* We create a 3-row wrapper where left/right only occupy the middle row */
    .layoutRows{
      display:grid;
      grid-template-columns: var(--side-col-w) 1fr var(--side-col-w);
      grid-template-rows: auto auto auto; /* front axle row, car row, rear axle row */
      gap: var(--gap);
      align-items:start;
    }
    .layoutRows .frontAxle{ grid-column: 2; grid-row: 1; }
    .layoutRows .carCell{ grid-column: 2; grid-row: 2; }
    .layoutRows .rearAxle{ grid-column: 2; grid-row: 3; }

    /* Left/right stacks pinned to row 2 (car row) and centered */
    .layoutRows .leftCol{ grid-column: 1; grid-row: 2; align-self:center; }
    .layoutRows .rightCol{ grid-column: 3; grid-row: 2; align-self:center; }
    .layoutRows .leftCol .sideStack,
    .layoutRows .rightCol .sideStack{
      transform: translateY(var(--side-y-nudge));
    }

    /* Bottom: Cross + Total side-by-side */
    .bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-top: 6px;
    }

    .notes{
      margin-top: 10px;
      border-top:1px solid #e3e3e3;
      padding-top: 10px;
    }
    textarea{
      width:100%;
      min-height: 100px;
      border:1px solid #bbb;
      border-radius:12px;
      padding:10px;
      font-size:15px;
      resize:vertical;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .btn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
    }

    /* Lock UI */
    .inwrap{ position:relative; width:100%; }
    .lockbtn{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-50%);
      border:1px solid #999;
      background:#fff;
      border-radius:10px;
      font-size:14px;
      padding:4px 6px;
      cursor:pointer;
      line-height:1;
    }
    .inwrap input{ padding-right:42px; }
    .lockedField{
      border:2px solid #111 !important;
      background:#f7f7f7 !important;
    }

    @media (max-width: 900px){
      :root{ --side-col-w: 1fr; --car-max: 520px; }
      .meta{ grid-template-columns: 1fr; }
      .meta2{ grid-template-columns: 1fr; }
      .logo img{ width: 80%; }

      /* On small screens stack everything */
      .layoutRows{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto; /* left, front, car, rear, right */
      }
      .layoutRows .leftCol{ grid-column:1; grid-row:1; }
      .layoutRows .frontAxle{ grid-column:1; grid-row:2; }
      .layoutRows .carCell{ grid-column:1; grid-row:3; }
      .layoutRows .rearAxle{ grid-column:1; grid-row:4; }
      .layoutRows .rightCol{ grid-column:1; grid-row:5; }
      .bottom{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="page" id="app">
    <div class="logo">
      <img src="ccc-logo.png" alt="CCC Motorsports" />
    </div>

    <div class="meta">
      <div class="field"><label>CAR YEAR:</label><input id="car_year" type="text" /></div>
      <div class="field"><label>MAKE:</label><input id="make" type="text" /></div>
      <div class="field"><label>MODEL:</label><input id="model" type="text" /></div>
    </div>

    <div class="meta2">
      <div class="field"><label>OWNER:</label><input id="owner" type="text" /></div>
      <div class="field"><label>DATE:</label><input id="date" type="text" placeholder="__/__/____" /></div>
    </div>

    <!-- CAD-like alignment: left/right stacks centered to car row -->
    <div class="layoutRows">

      <!-- FRONT AXLE (row 1, center) -->
      <div class="block frontAxle">
        <h3>FRONT AXLE</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <input data-k="FRONT_before_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="FRONT_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <input data-k="FRONT_after_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="FRONT_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>
        </div>
      </div>

      <!-- LEFT STACK (row 2, left) -->
      <div class="leftCol">
        <div class="sideStack">
          <div class="block">
            <h3>LF â€“ LEFT FRONT</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="LF_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LF_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="LF_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LF_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
            <div class="small">lbs entered; % auto</div>
          </div>

          <div class="block">
            <h3>LEFT SIDE</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="LEFT_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LEFT_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="LEFT_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LEFT_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>LR â€“ LEFT REAR</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="LR_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LR_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="LR_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="LR_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CAR IMAGE (row 2, center) -->
      <div class="carCell carRow">
        <img src="mustang-top.png" alt="1967 Mustang top view" />
      </div>

      <!-- RIGHT STACK (row 2, right) -->
      <div class="rightCol">
        <div class="sideStack">
          <div class="block">
            <h3>RF â€“ RIGHT FRONT</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="RF_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RF_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="RF_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RF_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>RIGHT SIDE</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="RIGHT_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RIGHT_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="RIGHT_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RIGHT_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>RR â€“ RIGHT REAR</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <input data-k="RR_before_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RR_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <input data-k="RR_after_lbs" type="number" step="0.1" inputmode="decimal" />
              <input data-k="RR_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
              <div class="unit">%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- REAR AXLE (row 3, center) -->
      <div class="block rearAxle">
        <h3>REAR AXLE</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <input data-k="REAR_before_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="REAR_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <input data-k="REAR_after_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="REAR_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>
        </div>
      </div>

    </div>

    <div class="bottom">
      <div class="block">
        <h3>CROSS WEIGHT (LF + RR)</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <input data-k="CROSS_before_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="CROSS_before_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <input data-k="CROSS_after_lbs" type="number" step="0.1" inputmode="decimal" />
          <input data-k="CROSS_after_pct" type="number" step="0.1" inputmode="decimal" disabled />
          <div class="unit">%</div>
        </div>
      </div>

      <div class="block">
        <h3>TOTAL VEHICLE WEIGHT</h3>
        <div class="rows" style="grid-template-columns:72px 1fr 1fr 42px;">
          <div class="rowlbl">Before</div>
          <input data-k="TOTAL_before_lbs" type="number" step="0.1" inputmode="decimal" />
          <div></div>
          <div class="unit">lbs</div>

          <div class="rowlbl">After</div>
          <input data-k="TOTAL_after_lbs" type="number" step="0.1" inputmode="decimal" />
          <div></div>
          <div class="unit">lbs</div>
        </div>
      </div>
    </div>

    <div class="notes">
      <h3 style="margin:6px 0 8px;">NOTES / ADJUSTMENTS</h3>
      <textarea id="notes" placeholder="Adjustments, ballast moves, spring changes, tire pressure, etc."></textarea>

      <div class="toolbar">
        <button class="btn secondary" id="clearBtn" type="button">Clear all weights</button>
        <button class="btn secondary" id="unlockAllBtn" type="button">Unlock all</button>
        <button class="btn" id="printBtn" type="button">Print</button>
      </div>
    </div>
  </div>

<script>
  const inputs = [...document.querySelectorAll('input[data-k]')];
  const map = new Map(inputs.map(i => [i.dataset.k, i]));
  function num(v){
    if(v===null||v===undefined) return null;
    const s=String(v).trim();
    if(!s) return null;
    const f=parseFloat(s);
    return Number.isFinite(f)?f:null;
  }
  function getKey(k){ return num(map.get(k)?.value); }
  const fmtLbs=(x)=>(Math.round(x*10)/10).toFixed(1);
  const fmtPct=(x)=>(Math.round(x*10)/10).toFixed(1);

  // locks
  const locked = new Set();

  // conflict banner
  function ensureBanner(){
    let b = document.getElementById("conflictBanner");
    if(b) return b;
    b = document.createElement("div");
    b.id = "conflictBanner";
    b.style.cssText = `
      display:none;
      margin: 10px 0 14px;
      padding: 10px 12px;
      border: 2px solid #b00020;
      background: #ffe9ee;
      border-radius: 12px;
      font-weight: 800;
    `;
    b.textContent = "Conflicting locked inputs â€” fix the red fields or unlock one.";
    const app = document.getElementById("app");
    app.insertBefore(b, app.children[3]);
    return b;
  }
  const banner = ensureBanner();

  function markConflict(k, isBad){
    const el = map.get(k);
    if(!el) return;
    if(isBad){
      el.style.border = "2px solid #b00020";
      el.style.background = "#ffe9ee";
      el.dataset.conflict = "1";
    }else{
      el.style.border = "";
      el.style.background = "";
      el.dataset.conflict = "0";
    }
  }
  function clearAllConflicts(){
    for(const [k] of map){
      if(k.endsWith("_lbs")) markConflict(k,false);
    }
    banner.style.display="none";
  }
  function showBannerIfNeeded(){
    for(const [,el] of map){
      if(el.dataset.conflict==="1"){ banner.style.display="block"; return; }
    }
    banner.style.display="none";
  }

  // inject lock buttons for lbs fields
  function injectLocks(){
    for(const el of inputs){
      const k = el.dataset.k;
      if(!k || !k.endsWith("_lbs")) continue;

      const wrap = document.createElement("div");
      wrap.className = "inwrap";
      el.parentNode.insertBefore(wrap, el);
      wrap.appendChild(el);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lockbtn";
      btn.textContent = "ðŸ”“";
      btn.title = "Lock/unlock this field";
      wrap.appendChild(btn);

      btn.addEventListener("click", ()=>{
        if(locked.has(k)){
          locked.delete(k);
          btn.textContent="ðŸ”“";
          el.classList.remove("lockedField");
        }else{
          locked.add(k);
          btn.textContent="ðŸ”’";
          el.classList.add("lockedField");
        }
        scheduleRecalc();
      });
    }
  }
  injectLocks();

  function setAuto(k, v, fmt){
    const el = map.get(k);
    if(!el) return;
    if(v===null||v===undefined||!Number.isFinite(v)) return;
    if(locked.has(k)) return;
    if(document.activeElement===el) return;

    const cur=String(el.value??'').trim();
    const isAuto=el.dataset.auto==="1";
    if(cur==="" || isAuto){
      el.value=fmt(v);
      el.dataset.auto="1";
    }
  }

  function safeDerive(prefix){
    const k=(name)=>`${name}_${prefix}_lbs`;

    const LF=getKey(k("LF")), RF=getKey(k("RF")), LR=getKey(k("LR")), RR=getKey(k("RR"));
    const FRONT=getKey(k("FRONT")), REAR=getKey(k("REAR")), LEFT=getKey(k("LEFT")), RIGHT=getKey(k("RIGHT"));
    const CROSS=getKey(k("CROSS")), TOTAL=getKey(k("TOTAL"));

    if(LF!=null && RF!=null) setAuto(k("FRONT"), LF+RF, fmtLbs);
    if(LR!=null && RR!=null) setAuto(k("REAR"),  LR+RR, fmtLbs);
    if(LF!=null && LR!=null) setAuto(k("LEFT"),  LF+LR, fmtLbs);
    if(RF!=null && RR!=null) setAuto(k("RIGHT"), RF+RR, fmtLbs);
    if(LF!=null && RR!=null) setAuto(k("CROSS"), LF+RR, fmtLbs);
    if(LF!=null && RF!=null && LR!=null && RR!=null) setAuto(k("TOTAL"), LF+RF+LR+RR, fmtLbs);

    const FRONT2=getKey(k("FRONT")), REAR2=getKey(k("REAR")), TOTAL2=getKey(k("TOTAL"));
    if(TOTAL2!=null && FRONT2!=null) setAuto(k("REAR"), TOTAL2-FRONT2, fmtLbs);
    if(TOTAL2!=null && REAR2!=null)  setAuto(k("FRONT"), TOTAL2-REAR2, fmtLbs);
    if(FRONT2!=null && REAR2!=null)  setAuto(k("TOTAL"), FRONT2+REAR2, fmtLbs);

    const LEFT2=getKey(k("LEFT")), RIGHT2=getKey(k("RIGHT")), TOTAL3=getKey(k("TOTAL"));
    if(TOTAL3!=null && LEFT2!=null)  setAuto(k("RIGHT"), TOTAL3-LEFT2, fmtLbs);
    if(TOTAL3!=null && RIGHT2!=null) setAuto(k("LEFT"),  TOTAL3-RIGHT2, fmtLbs);
    if(LEFT2!=null && RIGHT2!=null)  setAuto(k("TOTAL"), LEFT2+RIGHT2, fmtLbs);

    const LF2=getKey(k("LF")), RF2=getKey(k("RF")), LR2=getKey(k("LR")), RR2=getKey(k("RR"));
    const FRONT3=getKey(k("FRONT")), REAR3=getKey(k("REAR")), LEFT3=getKey(k("LEFT")), RIGHT3=getKey(k("RIGHT")), CROSS3=getKey(k("CROSS"));

    if(FRONT3!=null && LF2!=null) setAuto(k("RF"), FRONT3-LF2, fmtLbs);
    if(FRONT3!=null && RF2!=null) setAuto(k("LF"), FRONT3-RF2, fmtLbs);

    if(REAR3!=null && LR2!=null) setAuto(k("RR"), REAR3-LR2, fmtLbs);
    if(REAR3!=null && RR2!=null) setAuto(k("LR"), REAR3-RR2, fmtLbs);

    if(LEFT3!=null && LF2!=null) setAuto(k("LR"), LEFT3-LF2, fmtLbs);
    if(LEFT3!=null && LR2!=null) setAuto(k("LF"), LEFT3-LR2, fmtLbs);

    if(RIGHT3!=null && RF2!=null) setAuto(k("RR"), RIGHT3-RF2, fmtLbs);
    if(RIGHT3!=null && RR2!=null) setAuto(k("RF"), RIGHT3-RR2, fmtLbs);

    if(CROSS3!=null && LF2!=null) setAuto(k("RR"), CROSS3-LF2, fmtLbs);
    if(CROSS3!=null && RR2!=null) setAuto(k("LF"), CROSS3-RR2, fmtLbs);

    if(TOTAL2!=null){
      if(LF2!=null && RF2!=null && LR2!=null) setAuto(k("RR"), TOTAL2-LF2-RF2-LR2, fmtLbs);
      if(LF2!=null && RF2!=null && RR2!=null) setAuto(k("LR"), TOTAL2-LF2-RF2-RR2, fmtLbs);
      if(LF2!=null && LR2!=null && RR2!=null) setAuto(k("RF"), TOTAL2-LF2-LR2-RR2, fmtLbs);
      if(RF2!=null && LR2!=null && RR2!=null) setAuto(k("LF"), TOTAL2-RF2-LR2-RR2, fmtLbs);
    }
  }

  function fillPct(prefix){
    const total=getKey(`TOTAL_${prefix}_lbs`);
    if(total==null || Math.abs(total)<1e-9) return;
    const bases=["LF","RF","LR","RR","FRONT","REAR","LEFT","RIGHT","CROSS"];
    for(const b of bases){
      const v=getKey(`${b}_${prefix}_lbs`);
      if(v==null) continue;
      setAuto(`${b}_${prefix}_pct`, (v/total)*100, fmtPct);
    }
  }

  function approxEq(a,b){ return Math.abs(a-b) <= 0.2; }

  function checkConflicts(prefix){
    const K=(name)=>`${name}_${prefix}_lbs`;
    const v=(name)=>getKey(K(name));

    const LF=v("LF"), RF=v("RF"), LR=v("LR"), RR=v("RR");
    const FRONT=v("FRONT"), REAR=v("REAR"), LEFT=v("LEFT"), RIGHT=v("RIGHT"), CROSS=v("CROSS"), TOTAL=v("TOTAL");

    const checks=[
      ["FRONT", FRONT, (LF!=null&&RF!=null)? LF+RF : null],
      ["REAR",  REAR,  (LR!=null&&RR!=null)? LR+RR : null],
      ["LEFT",  LEFT,  (LF!=null&&LR!=null)? LF+LR : null],
      ["RIGHT", RIGHT, (RF!=null&&RR!=null)? RF+RR : null],
      ["CROSS", CROSS, (LF!=null&&RR!=null)? LF+RR : null],
      ["TOTAL", TOTAL, (LF!=null&&RF!=null&&LR!=null&&RR!=null)? LF+RF+LR+RR : null],
    ];

    let anyBad=false;
    for(const [name, actual, expected] of checks){
      const key=K(name);
      if(!locked.has(key)) continue;
      if(actual==null || expected==null) continue;
      if(!approxEq(actual, expected)){
        markConflict(key,true); anyBad=true;
      }else{
        markConflict(key,false);
      }
    }

    const cornerChecks=[
      ["LF", LF, (FRONT!=null&&RF!=null)? FRONT-RF : (LEFT!=null&&LR!=null)? LEFT-LR : (CROSS!=null&&RR!=null)? CROSS-RR : null],
      ["RF", RF, (FRONT!=null&&LF!=null)? FRONT-LF : (RIGHT!=null&&RR!=null)? RIGHT-RR : null],
      ["LR", LR, (REAR!=null&&RR!=null)? REAR-RR : (LEFT!=null&&LF!=null)? LEFT-LF : null],
      ["RR", RR, (REAR!=null&&LR!=null)? REAR-LR : (RIGHT!=null&&RF!=null)? RIGHT-RF : (CROSS!=null&&LF!=null)? CROSS-LF : null],
    ];
    for(const [name, actual, expected] of cornerChecks){
      const key=K(name);
      if(!locked.has(key)) continue;
      if(actual==null || expected==null) continue;
      if(!approxEq(actual, expected)){
        markConflict(key,true); anyBad=true;
      }else{
        markConflict(key,false);
      }
    }

    banner.style.display = anyBad ? "block" : "none";
  }

  function recalc(prefix){
    for(let i=0;i<6;i++) safeDerive(prefix);
    fillPct(prefix);
    checkConflicts(prefix);
  }

  function recalcAll(){
    clearAllConflicts();
    recalc('before');
    recalc('after');
    showBannerIfNeeded();
  }

  let t=null;
  function scheduleRecalc(){
    clearTimeout(t);
    t=setTimeout(recalcAll, 250);
  }

  for(const el of inputs){
    const k=el.dataset.k;
    if(!k || !k.endsWith('_lbs')) continue;
    el.addEventListener('input', ()=>{
      el.dataset.auto="0";
      scheduleRecalc();
    });
  }

  document.getElementById('unlockAllBtn').addEventListener('click', ()=>{
    locked.clear();
    document.querySelectorAll('.lockbtn').forEach(btn => btn.textContent="ðŸ”“");
    for(const [k,el] of map){
      if(k.endsWith('_lbs')) el.classList.remove("lockedField");
    }
    clearAllConflicts();
    recalcAll();
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    for(const [k,el] of map){
      el.value='';
      el.dataset.auto="0";
      el.dataset.conflict="0";
      el.classList.remove("lockedField");
      el.style.border="";
      el.style.background="";
    }
    locked.clear();
    banner.style.display="none";
    recalcAll();
  });

  document.getElementById('printBtn').addEventListener('click', ()=>window.print());

  recalcAll();
</script>
</body>
</html>
