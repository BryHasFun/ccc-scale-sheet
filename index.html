    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCC 4-Corner Scale Sheet</title>
  <style>
    :root{
      --page-w: 1180px;
      --gap: 14px;
      --border: 2px;
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;

      /* CAD-like layout tuning knobs */
      --car-max: 420px;
      --side-col-w: 360px;
      --side-y-nudge: 0px;

      /* Theme */
      --bg: #f2f2f2;
      --card: #ffffff;
      --text: #111111;
      --muted: rgba(0,0,0,.65);
      --line: #111111;
      --softline: #dcdcdc;
      --fieldbg: #ffffff;
      --fieldline: #bbbbbb;
      --danger: #b00020;
      --dangerbg: #ffe9ee;
      --btnbg: #111111;
      --btntext: #ffffff;
    }
    body.dark{
      --bg: #0f1115;
      --card: #151922;
      --text: #f2f2f2;
      --muted: rgba(255,255,255,.65);
      --line: #e7e7e7;
      --softline: rgba(255,255,255,.15);
      --fieldbg: #0f1115;
      --fieldline: rgba(255,255,255,.25);
      --btnbg: #f2f2f2;
      --btntext: #111111;
      --danger: #ff4d6d;
      --dangerbg: rgba(255,77,109,.15);
    }

    body{
      margin:0;
      background:var(--bg);
      font-family:var(--font);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .page{
      width: min(var(--page-w), 100%);
      background:var(--card);
      border:1px solid var(--softline);
      border-radius:18px;
      box-shadow: 0 8px 22px rgba(0,0,0,.08);
      padding: 18px;
    }

    /* Header */
    .logo{
      display:flex;
      justify-content:center;
      margin-top:4px;
      margin-bottom:10px;
    }
    .logo img{ max-width: 420px; width: 60%; height:auto; }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
      margin: 6px 0 10px;
    }
    .meta2{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      margin-bottom: 12px;
    }
    .field{
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .field label{
      font-weight:700;
      font-size:13px;
      color:var(--text);
    }

    input[type="text"], input[type="number"]{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--fieldline);
      border-radius:10px;
      font-size:16px;
      outline:none;
      background:var(--fieldbg);
      color:var(--text);
      box-sizing:border-box;
    }
    input[type="number"]{ appearance:textfield; }
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
input[type="number"]{ -moz-appearance: textfield; }
    input[data-k$="_pct"]{ max-width: 90px; }


    /* Top tools bar */
    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      margin: 8px 0 14px;
      border-top:1px solid var(--softline);
      padding-top: 12px;
    }
    .topbar .group{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .select{
      padding:10px 10px;
      border:1px solid var(--fieldline);
      border-radius:10px;
      background:var(--fieldbg);
      color:var(--text);
      font-size:15px;
      min-width: 240px;
    }
    .pill{
      font-weight:800;
      font-size:13px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--softline);
      color:var(--text);
      background:transparent;
      cursor:pointer;
    }

    /* Conflict banner */
    #conflictBanner{
      display:none;
      margin: 10px 0 14px;
      padding: 10px 12px;
      border: 2px solid var(--danger);
      background: var(--dangerbg);
      border-radius: 12px;
      font-weight: 800;
    }

    /* Blocks */
    .block{
      border: var(--border) solid var(--line);
      border-radius: var(--radius);
      padding: 10px 10px 12px;
      margin-bottom: 12px;
      background: transparent;
    }
    .block h3{
      margin:0 0 8px;
      font-size: 14px;
      letter-spacing:.2px;
    }

    /* Give lbs column more room than % column */
    .rows{
      display:grid;
      /* Fits inside side blocks while keeping lbs readable (4+ digits) and pct tight (e.g., 49.7) */
      grid-template-columns: 56px minmax(150px, 1fr) 72px 22px; /* rowlabel | lbs | % | unit */
      gap:6px;
      align-items:center;
    }
    .rows .rowlbl{
      font-weight:700;
      font-size:12px;
    }
    .unit{
      font-weight:700;
      font-size:12px;
      text-align:right;
      opacity:.9;
    }

    /* CAD-LIKE MAIN LAYOUT */
    .layoutRows{
      display:grid;
      grid-template-columns: var(--side-col-w) 1fr var(--side-col-w);
      grid-template-rows: auto auto auto;
      gap: var(--gap);
      align-items:start;
    }
    .layoutRows .frontAxle{ grid-column: 2; grid-row: 1; }
    .layoutRows .carCell{ grid-column: 2; grid-row: 2; }
    .layoutRows .rearAxle{ grid-column: 2; grid-row: 3; }
    .layoutRows .leftCol{ grid-column: 1; grid-row: 2; align-self:center; }
    .layoutRows .rightCol{ grid-column: 3; grid-row: 2; align-self:center; }

    .sideStack{
      transform: translateY(var(--side-y-nudge));
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .carRow{
      width: 100%;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
    }
    .carRow img{
      width: 100%;
      max-width: var(--car-max);
      height:auto;
      object-fit:contain;
      display:block;
      filter:none;
    }
    body.dark .carRow img{
      filter: invert(1) brightness(1.05);
      opacity: .92;
    }

    /* Bottom: Cross + Total side-by-side */
    .bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-top: 6px;
    }

    /* Delta + Target tools */
    .toolsRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-top: 10px;
    }
    .kvs{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      font-size:13px;
      align-items:center;
    }
    .kvs .k{ color: var(--muted); }
    .kvs .v{ font-weight:800; text-align:right; }
    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .targetLine{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .targetLine input{ max-width: 150px; }

    /* Notes */
    .notes{
      margin-top: 10px;
      border-top:1px solid var(--softline);
      padding-top: 10px;
    }
    textarea{
      width:100%;
      min-height: 100px;
      border:1px solid var(--fieldline);
      border-radius:12px;
      padding:10px;
      font-size:15px;
      resize:vertical;
      background:var(--fieldbg);
      color:var(--text);
      box-sizing:border-box;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--btnbg);
      color:var(--btntext);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--softline);
    }

    /* Lock UI: no overlap + keep input wide */
    .inwrap{
      display:grid;
      grid-template-columns: minmax(150px, 1fr) 22px; /* input takes the width */
      gap:6px;
      align-items:center;
      width:100%;
      min-width: 0;
    }
    .inwrap input{
      width:100%;
      min-width:0;
      padding-right:10px;
    }
    .lockbtn{
      width:22px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      border:1px solid var(--fieldline);
      background:var(--fieldbg);
      color:var(--text);
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      line-height:1;
      user-select:none;
    }
    .lockedField{
      border:2px solid var(--line) !important;
      background: rgba(0,0,0,.04) !important;
    }
    body.dark .lockedField{
      background: rgba(255,255,255,.06) !important;
    }

    /* Print */
    @media print{
      body{ background:#fff; padding:0; }
      .page{
        box-shadow:none;
        border:none;
        border-radius:0;
        padding: 0.3in;
        width: 8.5in;
      }
      .topbar, .toolsRow, .toolbar .secondary, .pill, #conflictBanner { display:none !important; }
      .btn{ display:none !important; }
      textarea{ min-height: 70px; }
      body.dark .carRow img{ filter:none; opacity:1; }
    }

    @media (max-width: 900px){
      :root{ --side-col-w: 1fr; --car-max: 520px; }
      .meta{ grid-template-columns: 1fr; }
      .meta2{ grid-template-columns: 1fr; }
      .logo img{ width: 80%; }

      .layoutRows{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto;
      }
      .layoutRows .leftCol{ grid-column:1; grid-row:1; }
      .layoutRows .frontAxle{ grid-column:1; grid-row:2; }
      .layoutRows .carCell{ grid-column:1; grid-row:3; }
      .layoutRows .rearAxle{ grid-column:1; grid-row:4; }
      .layoutRows .rightCol{ grid-column:1; grid-row:5; }

      .bottom{ grid-template-columns: 1fr; }
      .toolsRow{ grid-template-columns: 1fr; }
      .select{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="page" id="app">
    <div class="logo">
      <img src="./ccc-logo.png" alt="CCC Motorsports">
    </div>

    <div class="meta">
      <div class="field"><label>CAR YEAR:</label><input id="car_year" type="text"></div>
      <div class="field"><label>MAKE:</label><input id="make" type="text"></div>
      <div class="field"><label>MODEL:</label><input id="model" type="text"></div>
    </div>

    <div class="meta2">
      <div class="field"><label>OWNER:</label><input id="owner" type="text"></div>
      <div class="field"><label>DATE:</label><input id="date" type="text" placeholder="__/__/____"></div>
    </div>

    <div class="topbar">
      <div class="group">
        <select id="savedSelect" class="select">
          <option value="">Load saved setup‚Ä¶</option>
        </select>
        <button class="btn secondary" id="saveBtn" type="button">Save</button>
        <button class="btn secondary" id="newBtn" type="button">New setup</button>
      </div>
      <div class="group">
        <button class="pill" id="autosaveToggle" type="button" aria-pressed="true">Autosave: ON</button>
        <button class="pill" id="darkToggle" type="button" aria-pressed="false">Dark: OFF</button>
      </div>
    </div>

    <div id="conflictBanner">Conflicting locked inputs ‚Äî fix the red fields or unlock one.</div>

    <div class="layoutRows">

      <div class="block frontAxle">
        <h3>FRONT AXLE</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <div class="inwrap"><input data-k="FRONT_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="FRONT_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <div class="inwrap"><input data-k="FRONT_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="FRONT_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>
        </div>
      </div>

      <div class="leftCol">
        <div class="sideStack">
          <div class="block">
            <h3>LF ‚Äì LEFT FRONT</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="LF_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LF_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="LF_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LF_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>LEFT SIDE</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="LEFT_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LEFT_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="LEFT_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LEFT_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>LR ‚Äì LEFT REAR</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="LR_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LR_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="LR_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="LR_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="carCell">
        <div class="carRow">
          <img src="./mustang-top.png" alt="1967 Mustang top view">
        </div>
      </div>

      <div class="rightCol">
        <div class="sideStack">
          <div class="block">
            <h3>RF ‚Äì RIGHT FRONT</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="RF_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RF_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="RF_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RF_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>RIGHT SIDE</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="RIGHT_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RIGHT_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="RIGHT_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RIGHT_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>

          <div class="block">
            <h3>RR ‚Äì RIGHT REAR</h3>
            <div class="rows">
              <div class="rowlbl">Before</div>
              <div class="inwrap"><input data-k="RR_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RR_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>

              <div class="rowlbl">After</div>
              <div class="inwrap"><input data-k="RR_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
              <input data-k="RR_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
              <div class="unit">%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="block rearAxle">
        <h3>REAR AXLE</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <div class="inwrap"><input data-k="REAR_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="REAR_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <div class="inwrap"><input data-k="REAR_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="REAR_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>
        </div>
      </div>

    </div>

    <div class="bottom">
      <div class="block">
        <h3>CROSS WEIGHT / DIAGONAL (LF + RR)</h3>
        <div class="rows">
          <div class="rowlbl">Before</div>
          <div class="inwrap"><input data-k="CROSS_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="CROSS_before_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>

          <div class="rowlbl">After</div>
          <div class="inwrap"><input data-k="CROSS_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <input data-k="CROSS_after_pct" type="number" step="0.1" inputmode="decimal" disabled>
          <div class="unit">%</div>
        </div>
      </div>

      <div class="block">
        <h3>TOTAL VEHICLE WEIGHT</h3>
        <div class="rows" style="grid-template-columns:72px 1.65fr 1fr 42px;">
          <div class="rowlbl">Before</div>
          <div class="inwrap"><input data-k="TOTAL_before_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <div></div>
          <div class="unit">lbs</div>

          <div class="rowlbl">After</div>
          <div class="inwrap"><input data-k="TOTAL_after_lbs" type="number" step="0.1" inputmode="decimal"><button type="button" class="lockbtn">üîì</button></div>
          <div></div>
          <div class="unit">lbs</div>
        </div>
      </div>
    </div>

    <div class="toolsRow">
      <div class="block">
        <h3>DELTA (After ‚àí Before)</h3>
        <div class="kvs" id="deltaPanel"></div>
        <div class="hint">This is a quick ‚Äúwhat changed‚Äù snapshot for setup adjustments.</div>
      </div>

      <div class="block">
        <h3>TARGET CROSS %</h3>
        <div class="targetLine">
          <label style="font-weight:800;">Target:</label>
          <input id="targetCross" type="number" step="0.1" inputmode="decimal" placeholder="50.0">
          <span style="font-weight:800;">%</span>
          <button class="btn secondary" id="applyTargetBtn" type="button">Set 50.0</button>
        </div>
        <div class="kvs" style="margin-top:10px;">
          <div class="k">Current Cross (After)</div><div class="v" id="curCrossAfter">‚Äî</div>
          <div class="k">Target Cross lbs (After)</div><div class="v" id="targetCrossLbsAfter">‚Äî</div>
          <div class="k">You are off by</div><div class="v" id="crossDeltaAfter">‚Äî</div>
        </div>
        <div class="hint">
          If Cross is <b>high</b>, you‚Äôre heavy on <b>LF+RR</b> diagonal. If Cross is <b>low</b>, heavy on <b>RF+LR</b>.
          Lock values you trust; red fields mean the locked numbers contradict each other.
        </div>
      </div>
    </div>

    <div class="notes">
      <h3 style="margin:6px 0 8px;">NOTES / ADJUSTMENTS</h3>
      <textarea id="notes" placeholder="Adjustments, ballast moves, spring changes, tire pressure, etc."></textarea>

      <div class="toolbar">
        <button class="btn secondary" id="clearBtn" type="button">Clear all weights</button>
        <button class="btn secondary" id="unlockAllBtn" type="button">Unlock all</button>
        <button class="btn" id="printBtn" type="button">Print / Save PDF</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const inputs = [...document.querySelectorAll('input[data-k]')];
  const map = new Map(inputs.map(i => [i.dataset.k, i]));
  const banner = document.getElementById("conflictBanner");

  const meta = {
    year: document.getElementById('car_year'),
    make: document.getElementById('make'),
    model: document.getElementById('model'),
    owner: document.getElementById('owner'),
    date: document.getElementById('date'),
    notes: document.getElementById('notes')
  };

  const locked = new Set();

  function num(v){
    if(v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function fmtLbs(n){
    const s = (Math.round(n*10)/10).toFixed(1);
    return s.endsWith(".0") ? s.slice(0,-2) : s;
  }
  function fmtPct(n){ return (Math.round(n*10)/10).toFixed(1); }
  function isLocked(key){ return locked.has(key); }  function setVal(key, value, {auto=false}={}){
    const el = map.get(key);
    if(!el) return;
    if(isLocked(key)) return;

    // Preserve user-entered values. Only overwrite if:
    // - field is empty, OR
    // - field was previously auto-derived (dataset.auto === "1")
    const prev = el.value;
    const wasAuto = el.dataset.auto === "1";
    if(auto && prev !== "" && !wasAuto) return;

    el.value = (value==null) ? "" : fmtLbs(value);
    el.dataset.auto = auto ? "1" : "0";
  }

  function getKey(key){
    const el = map.get(key);
    if(!el) return null;
    return num(el.value);
  }

  function approxEq(a,b){ return Math.abs(a-b) <= 0.2; }

  function clearAllConflicts(){
    for(const el of inputs){
      el.dataset.conflict = "0";
      if(el.dataset.k?.endsWith('_lbs')){
        el.style.border = "";
        el.style.background = "";
      }
    }
  }
  function markConflict(key, on){
    const el = map.get(key);
    if(!el) return;
    if(on){
      el.style.border = "2px solid var(--danger)";
      el.style.background = "var(--dangerbg)";
    } else {
      el.style.border = "";
      el.style.background = "";
    }
  }

  function K(name, prefix){ return `${name}_${prefix}_lbs`; }

  function derive(prefix){
    const v = (name)=>getKey(K(name,prefix));
    let LF=v("LF"), RF=v("RF"), LR=v("LR"), RR=v("RR");
    let FRONT=v("FRONT"), REAR=v("REAR"), LEFT=v("LEFT"), RIGHT=v("RIGHT"), CROSS=v("CROSS"), TOTAL=v("TOTAL");
    const S = (name, val)=>setVal(K(name,prefix), val, {auto:true});

    if(FRONT==null && LF!=null && RF!=null) S("FRONT", LF+RF);
    if(REAR==null  && LR!=null && RR!=null) S("REAR",  LR+RR);
    if(LEFT==null  && LF!=null && LR!=null) S("LEFT",  LF+LR);
    if(RIGHT==null && RF!=null && RR!=null) S("RIGHT", RF+RR);
    if(CROSS==null && LF!=null && RR!=null) S("CROSS", LF+RR);
    if(TOTAL==null && LF!=null && RF!=null && LR!=null && RR!=null) S("TOTAL", LF+RF+LR+RR);

    LF=v("LF"); RF=v("RF"); LR=v("LR"); RR=v("RR");
    FRONT=v("FRONT"); REAR=v("REAR"); LEFT=v("LEFT"); RIGHT=v("RIGHT"); CROSS=v("CROSS"); TOTAL=v("TOTAL");

    if(LF==null && FRONT!=null && RF!=null) S("LF", FRONT-RF);
    if(RF==null && FRONT!=null && LF!=null) S("RF", FRONT-LF);

    if(LR==null && REAR!=null && RR!=null) S("LR", REAR-RR);
    if(RR==null && REAR!=null && LR!=null) S("RR", REAR-LR);

    if(LF==null && LEFT!=null && LR!=null) S("LF", LEFT-LR);
    if(LR==null && LEFT!=null && LF!=null) S("LR", LEFT-LF);

    if(RF==null && RIGHT!=null && RR!=null) S("RF", RIGHT-RR);
    if(RR==null && RIGHT!=null && RF!=null) S("RR", RIGHT-RF);

    if(LF==null && CROSS!=null && RR!=null) S("LF", CROSS-RR);
    if(RR==null && CROSS!=null && LF!=null) S("RR", CROSS-LF);

    if(LF==null && TOTAL!=null && RF!=null && LR!=null && RR!=null) S("LF", TOTAL-RF-LR-RR);
    if(RF==null && TOTAL!=null && LF!=null && LR!=null && RR!=null) S("RF", TOTAL-LF-LR-RR);
    if(LR==null && TOTAL!=null && LF!=null && RF!=null && RR!=null) S("LR", TOTAL-LF-RF-RR);
    if(RR==null && TOTAL!=null && LF!=null && RF!=null && LR!=null) S("RR", TOTAL-LF-RF-LR);

    FRONT=v("FRONT"); REAR=v("REAR"); LEFT=v("LEFT"); RIGHT=v("RIGHT"); CROSS=v("CROSS");
    if(TOTAL==null && FRONT!=null && REAR!=null) S("TOTAL", FRONT+REAR);
    if(TOTAL==null && LEFT!=null && RIGHT!=null) S("TOTAL", LEFT+RIGHT);
    if(TOTAL==null && CROSS!=null && RF!=null && LR!=null) S("TOTAL", CROSS + RF + LR);

    TOTAL=v("TOTAL");
    if(FRONT==null && TOTAL!=null && REAR!=null) S("FRONT", TOTAL-REAR);
    if(REAR==null  && TOTAL!=null && FRONT!=null) S("REAR",  TOTAL-FRONT);
    if(LEFT==null  && TOTAL!=null && RIGHT!=null) S("LEFT",  TOTAL-RIGHT);
    if(RIGHT==null && TOTAL!=null && LEFT!=null) S("RIGHT", TOTAL-LEFT);
  }

  function fillPct(prefix){
    const total = getKey(`TOTAL_${prefix}_lbs`);
    const pctFor = (lbs)=> (total==null || lbs==null || total===0) ? null : (lbs/total)*100;
    for(const name of ["LF","RF","LR","RR","FRONT","REAR","LEFT","RIGHT","CROSS"]){
      const lbs = getKey(`${name}_${prefix}_lbs`);
      const pct = pctFor(lbs);
      const el = map.get(`${name}_${prefix}_pct`);
      if(el) el.value = (pct==null) ? "" : fmtPct(pct);
    }
  }

  function checkConflicts(prefix){
    const v=(name)=>getKey(`${name}_${prefix}_lbs`);
    const LF=v("LF"), RF=v("RF"), LR=v("LR"), RR=v("RR");
    const FRONT=v("FRONT"), REAR=v("REAR"), LEFT=v("LEFT"), RIGHT=v("RIGHT"), CROSS=v("CROSS"), TOTAL=v("TOTAL");

    const checks=[
      ["FRONT", FRONT, (LF!=null&&RF!=null)? LF+RF : null],
      ["REAR",  REAR,  (LR!=null&&RR!=null)? LR+RR : null],
      ["LEFT",  LEFT,  (LF!=null&&LR!=null)? LF+LR : null],
      ["RIGHT", RIGHT, (RF!=null&&RR!=null)? RF+RR : null],
      ["CROSS", CROSS, (LF!=null&&RR!=null)? LF+RR : null],
      ["TOTAL", TOTAL, (LF!=null&&RF!=null&&LR!=null&&RR!=null)? LF+RF+LR+RR : null],
    ];

    let anyBad=false;
    for(const [name, actual, expected] of checks){
      const key = `${name}_${prefix}_lbs`;
      if(!isLocked(key)) continue;
      if(actual==null || expected==null) continue;
      if(!approxEq(actual, expected)){ markConflict(key,true); anyBad=true; }
      else markConflict(key,false);
    }

    const cornerChecks=[
      ["LF", LF, (FRONT!=null&&RF!=null)? FRONT-RF : (LEFT!=null&&LR!=null)? LEFT-LR : (CROSS!=null&&RR!=null)? CROSS-RR : null],
      ["RF", RF, (FRONT!=null&&LF!=null)? FRONT-LF : (RIGHT!=null&&RR!=null)? RIGHT-RR : null],
      ["LR", LR, (REAR!=null&&RR!=null)? REAR-RR : (LEFT!=null&&LF!=null)? LEFT-LF : null],
      ["RR", RR, (REAR!=null&&LR!=null)? REAR-LR : (RIGHT!=null&&RF!=null)? RIGHT-RF : (CROSS!=null&&LF!=null)? CROSS-LF : null],
    ];
    for(const [name, actual, expected] of cornerChecks){
      const key = `${name}_${prefix}_lbs`;
      if(!isLocked(key)) continue;
      if(actual==null || expected==null) continue;
      if(!approxEq(actual, expected)){ markConflict(key,true); anyBad=true; }
      else markConflict(key,false);
    }

    banner.style.display = anyBad ? "block" : "none";
  }

  const deltaPanel = document.getElementById('deltaPanel');
  const targetCross = document.getElementById('targetCross');
  const curCrossAfter = document.getElementById('curCrossAfter');
  const targetCrossLbsAfter = document.getElementById('targetCrossLbsAfter');
  const crossDeltaAfter = document.getElementById('crossDeltaAfter');

  const deltaKeys = [
    ["LF", "LF"], ["RF","RF"], ["LR","LR"], ["RR","RR"],
    ["Front","FRONT"], ["Rear","REAR"],
    ["Left","LEFT"], ["Right","RIGHT"],
    ["Cross","CROSS"], ["Total","TOTAL"],
  ];

  function renderDelta(){
    const rows = [];
    for(const [label, key] of deltaKeys){
      const bL = getKey(`${key}_before_lbs`);
      const aL = getKey(`${key}_after_lbs`);
      const bP = num(map.get(`${key}_before_pct`)?.value);
      const aP = num(map.get(`${key}_after_pct`)?.value);

      const dL = (aL!=null && bL!=null) ? (aL - bL) : null;
      const dP = (aP!=null && bP!=null) ? (aP - bP) : null;

      const lbsTxt = dL==null ? "‚Äî" : `${dL>=0?"+":""}${fmtLbs(dL)} lbs`;
      const pctTxt = dP==null ? "" : ` (${dP>=0?"+":""}${fmtPct(dP)}%)`;

      rows.push({k: label, v: lbsTxt + pctTxt});
    }
    deltaPanel.innerHTML = rows.map(r =>
      `<div class="k">${r.k}</div><div class="v">${r.v}</div>`
    ).join("");
  }

  function renderTargetCross(){
    const totalA = getKey(`TOTAL_after_lbs`);
    const crossA = getKey(`CROSS_after_lbs`);
    const crossPctA = num(map.get(`CROSS_after_pct`)?.value);
    curCrossAfter.textContent = (crossPctA==null) ? "‚Äî" : `${fmtPct(crossPctA)}%`;

    const targetPct = num(targetCross.value);
    if(totalA==null || targetPct==null){
      targetCrossLbsAfter.textContent = "‚Äî";
      crossDeltaAfter.textContent = "‚Äî";
      return;
    }
    const targetLbs = totalA * (targetPct/100);
    targetCrossLbsAfter.textContent = `${fmtLbs(targetLbs)} lbs`;

    if(crossA==null){ crossDeltaAfter.textContent = "‚Äî"; return; }
    const off = crossA - targetLbs;
    crossDeltaAfter.textContent = `${off>=0?"+":""}${fmtLbs(off)} lbs`;
  }

  function recalc(prefix){
    // Clear previously auto-derived lbs values so they can be recomputed from the current user inputs.
    // User-entered values (dataset.auto !== "1") stay in place unless locked conflicts are detected.
    for(const [k, el] of map){
      if(!k.endsWith(`_${prefix}_lbs`)) continue;
      if(isLocked(k)) continue;
      if(el.dataset.auto === "1"){
        el.value = "";
        el.dataset.auto = "0";
      }
    }

    // Solve by repeatedly applying derivation rules until no more fields can be filled.
    for(let i=0;i<12;i++) derive(prefix);

    fillPct(prefix);
    checkConflicts(prefix);
  }

  function recalcAll(){
    clearAllConflicts();
    recalc('before');
    recalc('after');
    renderDelta();
    renderTargetCross();
  }

  let t=null;
  function scheduleRecalc(){ clearTimeout(t); t=setTimeout(recalcAll, 200); }

  const AUTOSAVE_KEY = "ccc_autosave_enabled_v1";
  const SAVE_PREFIX = "ccc_setup_v1_";
  const SAVE_INDEX_KEY = "ccc_setup_index_v1";
  let autosaveEnabled = (localStorage.getItem(AUTOSAVE_KEY) ?? "1") === "1";

  function snapshot(){
    const fields = {};
    for(const [k, el] of map){
      if(el.disabled) continue;
      const v = el.value;
      if(v !== "") fields[k] = v;
    }
    return {
      meta: {
        car_year: meta.year.value, make: meta.make.value, model: meta.model.value,
        owner: meta.owner.value, date: meta.date.value, notes: meta.notes.value,
        dark: document.body.classList.contains("dark") ? 1 : 0
      },
      fields,
      locks: [...locked]
    };
  }

  function applySnapshot(data){
    if(data.meta){
      meta.year.value = data.meta.car_year ?? "";
      meta.make.value = data.meta.make ?? "";
      meta.model.value = data.meta.model ?? "";
      meta.owner.value = data.meta.owner ?? "";
      meta.date.value = data.meta.date ?? "";
      meta.notes.value = data.meta.notes ?? "";
      document.body.classList.toggle("dark", !!data.meta.dark);
      updateDarkToggle();
    }

    for(const [k, el] of map){
      if(k.endsWith('_lbs')){ el.value=""; el.dataset.auto="0"; }
      markConflict(k,false);
    }

    if(data.fields){
      for(const [k, v] of Object.entries(data.fields)){
        const el = map.get(k);
        if(el) { el.value = v; el.dataset.auto="0"; }
      }
    }

    locked.clear();
    document.querySelectorAll('.lockbtn').forEach(btn => btn.textContent="üîì");
    document.querySelectorAll('input[data-k$="_lbs"]').forEach(inp=>inp.classList.remove("lockedField"));
    if(Array.isArray(data.locks)){
      for(const k of data.locks){
        if(map.has(k)){
          locked.add(k);
          const el = map.get(k);
          el.classList.add("lockedField");
          const btn = el.parentElement?.querySelector?.(".lockbtn");
          if(btn) btn.textContent="üîí";
        }
      }
    }
    recalcAll();
  }

  function getIndex(){ try{ return JSON.parse(localStorage.getItem(SAVE_INDEX_KEY) || "[]"); }catch{ return []; } }
  function setIndex(arr){ localStorage.setItem(SAVE_INDEX_KEY, JSON.stringify(arr)); }

  function titleForSnapshot(snap){
    const y = snap?.meta?.car_year?.trim() || "";
    const mk = snap?.meta?.make?.trim() || "";
    const md = snap?.meta?.model?.trim() || "";
    const ow = snap?.meta?.owner?.trim() || "";
    const dt = snap?.meta?.date?.trim() || "";
    const base = [y, mk, md].filter(Boolean).join(" ");
    const tail = [ow ? `‚Ä¢ ${ow}` : "", dt ? `‚Ä¢ ${dt}` : ""].filter(Boolean).join(" ");
    return (base || "Untitled") + (tail ? ` ${tail}` : "");
  }

  function saveSetup(id=null){
    const snap = snapshot();
    const setupId = id || `${Date.now()}`;
    localStorage.setItem(SAVE_PREFIX + setupId, JSON.stringify(snap));
    if(setupId !== "__autosave__"){
      const idx = getIndex();
      if(!idx.includes(setupId)){ idx.unshift(setupId); setIndex(idx.slice(0, 50)); }
    }
    return setupId;
  }
  function loadSetup(id){
    try{
      const raw = localStorage.getItem(SAVE_PREFIX + id);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  const savedSelect = document.getElementById('savedSelect');
  function refreshSavedList(){
    const idx = getIndex();
    const opts = ['<option value="">Load saved setup‚Ä¶</option>'];
    const auto = loadSetup("__autosave__");
    if(auto) opts.push(`<option value="__autosave__">üü¶ Autosave ‚Äî ${titleForSnapshot(auto)}</option>`);
    for(const id of idx){
      const snap = loadSetup(id);
      if(!snap) continue;
      opts.push(`<option value="${id}">üìå ${titleForSnapshot(snap)}</option>`);
    }
    savedSelect.innerHTML = opts.join("");
  }

  function scheduleAutosave(){
    if(!autosaveEnabled) return;
    clearTimeout(scheduleAutosave._t);
    scheduleAutosave._t = setTimeout(()=>{ saveSetup("__autosave__"); refreshSavedList(); }, 500);
  }

  const autosaveToggle = document.getElementById('autosaveToggle');
  function updateAutosaveToggle(){
    autosaveToggle.textContent = `Autosave: ${autosaveEnabled ? "ON" : "OFF"}`;
    autosaveToggle.setAttribute("aria-pressed", autosaveEnabled ? "true" : "false");
  }
  updateAutosaveToggle();
  autosaveToggle.addEventListener('click', ()=>{
    autosaveEnabled = !autosaveEnabled;
    localStorage.setItem(AUTOSAVE_KEY, autosaveEnabled ? "1" : "0");
    updateAutosaveToggle();
    if(autosaveEnabled) scheduleAutosave();
  });

  const darkToggle = document.getElementById('darkToggle');
  function updateDarkToggle(){
    const on = document.body.classList.contains("dark");
    darkToggle.textContent = `Dark: ${on ? "ON" : "OFF"}`;
    darkToggle.setAttribute("aria-pressed", on ? "true" : "false");
  }
  updateDarkToggle();
  darkToggle.addEventListener('click', ()=>{ document.body.classList.toggle("dark"); updateDarkToggle(); scheduleAutosave(); });

  document.getElementById('saveBtn').addEventListener('click', ()=>{ saveSetup(null); refreshSavedList(); alert("Saved."); });
  savedSelect.addEventListener('change', ()=>{
    const id = savedSelect.value;
    if(!id) return;
    const snap = loadSetup(id);
    if(!snap){ alert("Could not load that setup."); return; }
    applySnapshot(snap);
    savedSelect.value = "";
  });

  document.getElementById('newBtn').addEventListener('click', ()=>{
    for(const [k, el] of map){
      if(k.endsWith('_lbs')) el.value='';
      el.dataset.auto="0";
      el.style.border=""; el.style.background="";
      el.classList.remove("lockedField");
    }
    meta.notes.value = "";
    locked.clear();
    banner.style.display="none";
    document.querySelectorAll('.lockbtn').forEach(btn => btn.textContent="üîì");
    recalcAll(); scheduleAutosave();
  });

  document.getElementById('applyTargetBtn').addEventListener('click', ()=>{ targetCross.value="50.0"; renderTargetCross(); scheduleAutosave(); });
  targetCross.addEventListener('input', ()=>{ renderTargetCross(); scheduleAutosave(); });

  document.querySelectorAll('.inwrap').forEach(wrap=>{
    const input = wrap.querySelector('input[type="number"]');
    const btn = wrap.querySelector('.lockbtn');
    if(!input || !btn) return;
    const key = input.dataset.k;
    if(!key.endsWith('_lbs')){ btn.style.display="none"; return; }

    btn.addEventListener('click', ()=>{
      const nowLocked = !locked.has(key);
      if(nowLocked) locked.add(key); else locked.delete(key);
      input.classList.toggle("lockedField", nowLocked);
      btn.textContent = nowLocked ? "üîí" : "üîì";
      recalcAll(); scheduleAutosave();
    });
  });

  document.getElementById('unlockAllBtn').addEventListener('click', ()=>{
    locked.clear();
    document.querySelectorAll('input[data-k$="_lbs"]').forEach(inp=>inp.classList.remove("lockedField"));
    document.querySelectorAll('.lockbtn').forEach(btn=>btn.textContent="üîì");
    recalcAll(); scheduleAutosave();
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    for(const [k, el] of map){
      if(k.endsWith('_lbs') && !isLocked(k)){
        el.value=''; el.dataset.auto="0";
      }
    }
    recalcAll(); scheduleAutosave();
  });

  document.getElementById('printBtn').addEventListener('click', ()=> window.print());

  for(const el of inputs){
    if(el.disabled) continue;
    el.addEventListener('input', ()=>{ el.dataset.auto="0"; scheduleRecalc(); scheduleAutosave(); });
  }
  for(const el of [meta.year, meta.make, meta.model, meta.owner, meta.date, meta.notes]){
    el.addEventListener('input', ()=> scheduleAutosave());
  }

  refreshSavedList();
  const auto = loadSetup("__autosave__");
  if(auto) applySnapshot(auto);
  else recalcAll();
})();
</script>
</body>
</html>
